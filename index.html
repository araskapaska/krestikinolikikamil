<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Крестики-нолики</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            text-align: center;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        #lobby {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        #board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            width: min(90vw, 360px);
            margin: 20px auto;
            display: none;
        }
        .cell {
            aspect-ratio: 1;
            background: #2c2c2c;
            border: 2px solid #444;
            border-radius: 12px;
            font-size: clamp(2rem, 10vw, 3rem);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }
        .cell:hover {
            background: #3a3a3a;
            transform: scale(1.05);
        }
        .cell:active {
            transform: scale(0.95);
        }
        #status {
            font-size: clamp(1.2rem, 5vw, 1.5rem);
            margin: 20px 0;
            color: #b0b0b0;
        }
        #lobby input, #lobby button, #resetButton {
            padding: 12px 20px;
            font-size: 1rem;
            border-radius: 25px;
            border: none;
            outline: none;
            transition: background 0.2s, transform 0.1s;
            cursor: pointer;
        }
        #lobby input {
            background: #333;
            color: #e0e0e0;
            width: min(80vw, 200px);
            text-align: center;
        }
        #lobby input::placeholder {
            color: #888;
        }
        #lobby button, #resetButton {
            background: #6200ea;
            color: #fff;
        }
        #lobby button:hover, #resetButton:hover {
            background: #7f39fb;
            transform: translateY(-2px);
        }
        #lobby button:active, #resetButton:active {
            transform: translateY(0);
        }
        @media (max-width: 600px) {
            h1 {
                font-size: 2rem;
            }
            #board {
                width: min(90vw, 300px);
            }
            #lobby input, #lobby button, #resetButton {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }
        @media (max-width: 400px) {
            #board {
                width: min(90vw, 240px);
            }
            .cell {
                font-size: clamp(1.5rem, 8vw, 2rem);
            }
        }
    </style>
</head>
<body>
    <h1>Крестики-нолики</h1>
    <div id="lobby">
        <button onclick="createRoom()">Создать комнату</button>
        <div>
            <input id="roomCodeInput" type="text" placeholder="Введите код комнаты">
            <button onclick="joinRoom()">Присоединиться</button>
        </div>
    </div>
    <div id="status">Ожидание выбора комнаты...</div>
    <div id="board">
        <div class="cell" id="0" onclick="makeMove(0)"></div>
        <div class="cell" id="1" onclick="makeMove(1)"></div>
        <div class="cell" id="2" onclick="makeMove(2)"></div>
        <div class="cell" id="3" onclick="makeMove(3)"></div>
        <div class="cell" id="4" onclick="makeMove(4)"></div>
        <div class="cell" id="5" onclick="makeMove(5)"></div>
        <div class="cell" id="6" onclick="makeMove(6)"></div>
        <div class="cell" id="7" onclick="makeMove(7)"></div>
        <div class="cell" id="8" onclick="makeMove(8)"></div>
    </div>
    <button onclick="resetGame()" style="display: none;" id="resetButton">Новая игра</button>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getDatabase, ref, set, push, onValue, update, get } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyB6cej6YPuHJdI96a8G9mppMQPMftjencA",
            authDomain: "krestiki-noliki-d24c3.firebaseapp.com",
            databaseURL: "https://krestiki-noliki-d24c3-default-rtdb.firebaseio.com",
            projectId: "krestiki-noliki-d24c3",
            storageBucket: "krestiki-noliki-d24c3.firebasestorage.app",
            messagingSenderId: "163098662385",
            appId: "1:163098662385:web:328361f5e1239abc61e050",
            measurementId: "G-D6XZDRM477"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let mySymbol = null;
        let currentPlayer = 'X';
        let board = ['', '', '', '', '', '', '', '', ''];
        let gameActive = false;
        let roomCode = null;

        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        async function createRoom() {
            try {
                const newRoomCode = generateRoomCode();
                await set(ref(db, `rooms/${newRoomCode}`), {
                    players: ['X'],
                    board: '         ',
                    currentPlayer: 'X'
                });
                roomCode = newRoomCode;
                document.getElementById('status').textContent = `Код комнаты: ${roomCode}. Ожидание второго игрока...`;
                joinRoomAsPlayer(newRoomCode, 'X');
            } catch (error) {
                document.getElementById('status').textContent = 'Ошибка при создании комнаты: ' + error.message;
            }
        }

        async function joinRoom() {
            const inputRoomCode = document.getElementById('roomCodeInput').value.toUpperCase();
            if (!inputRoomCode) {
                document.getElementById('status').textContent = 'Введите код комнаты';
                return;
            }
            try {
                const snapshot = await get(ref(db, `rooms/${inputRoomCode}`));
                if (snapshot.exists()) {
                    const room = snapshot.val();
                    if (room.players.length < 2) {
                        await push(ref(db, `rooms/${inputRoomCode}/players`), 'O');
                        roomCode = inputRoomCode;
                        joinRoomAsPlayer(inputRoomCode, 'O');
                    } else {
                        document.getElementById('status').textContent = 'Комната заполнена';
                    }
                } else {
                    document.getElementById('status').textContent = 'Комната не найдена';
                }
            } catch (error) {
                document.getElementById('status').textContent = 'Ошибка: ' + error.message;
            }
        }

        function joinRoomAsPlayer(code, symbol) {
            mySymbol = symbol;
            roomCode = code;
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('board').style.display = 'grid';
            document.getElementById('resetButton').style.display = 'block';
            gameActive = true;

            onValue(ref(db, `rooms/${roomCode}`), snapshot => {
                if (!snapshot.exists()) {
                    document.getElementById('status').textContent = 'Комната закрыта';
                    gameActive = false;
                    return;
                }
                const room = snapshot.val();
                board = room.board.split('');
                currentPlayer = room.currentPlayer;
                updateBoard();
                checkGameStatus();
                document.getElementById('status').textContent = `Вы играете за ${mySymbol}. Ходит: ${currentPlayer}`;
            });
        }

        function makeMove(cellIndex) {
            if (!gameActive || board[cellIndex] !== '' || currentPlayer !== mySymbol) return;
            board[cellIndex] = mySymbol;
            const newBoard = board.join('');
            update(ref(db, `rooms/${roomCode}`), {
                board: newBoard,
                currentPlayer: currentPlayer === 'X' ? 'O' : 'X'
            });
        }

        function updateBoard() {
            for (let i = 0; i < 9; i++) {
                document.getElementById(i).textContent = board[i];
            }
        }

        function checkGameStatus() {
            const winPatterns = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8],
                [0, 3, 6], [1, 4, 7], [2, 5, 8],
                [0, 4, 8], [2, 4, 6]
            ];
            for (const pattern of winPatterns) {
                const [a, b, c] = pattern;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    gameActive = false;
                    document.getElementById('status').textContent = `${board[a]} победил!`;
                    return;
                }
            }
            if (!board.includes('')) {
                gameActive = false;
                document.getElementById('status').textContent = 'Ничья!';
            }
        }

        function resetGame() {
            update(ref(db, `rooms/${roomCode}`), {
                board: '         ',
                currentPlayer: 'X'
            });
            gameActive = true;
        }
    </script>
</body>
</html>
